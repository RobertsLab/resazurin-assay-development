---
title: Oxygen rate extraction 
author: "AS Huffmyer"
date: '2025'
output:
  github_document: null
  md_document: default
  html_document:
    code_folding: hide
    toc: true
    toc_depth: 6
    toc_float: true
editor_options: 
  chunk_output_type: console
---

This script conducts correlations between respiration and resazurin rates.      

# Set up 

Set up workspace, set options, and load required packages.    
```{r}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```

```{r}
library(tidyverse)
library(lme4)
library(lmerTest)
library(emmeans)
library(ggplot2)
```

# Read in files 

Read in oxygen files 
```{r}
resp<-read_csv(file="output/oxygen-correlation/extracted_oxygen_rates.csv")%>%select(!c("plate", "well", "length.mm"))

resazurin<-read_csv(file="output/oxygen-correlation/resazurin_oyster_metrics.csv")

df<-left_join(resp, resazurin)%>%rename(resazurin_slope=slope, resazurin_total=value)

head(df)
```

Check for outliers 
```{r}
hist(df$resazurin_total)
hist(df$R.umol.mm.min)
```

Remove resazurin outliers
```{r}
df<-df%>%
  filter(resazurin_total<1.1)
```

Change respiration to inverse so that a higher value means higher metabolic rate. 
```{r}
df$R.umol.mm.min<-df$R.umol.mm.min*-1
```

Remove respiration values that are close to 0 and upper outliers.  

```{r}
hist(df$R.umol.mm.min)

df<-df%>%
  filter(R.umol.mm.min>0.0002)%>%
  filter(R.umol.mm.min<0.0006)

hist(df$R.umol.mm.min)
```

Transform variables. 

```{r}
df$resazurin_total_t<-log(1+df$resazurin_total)

hist(df$resazurin_total_t)

df$R.umol.mm.min_t<-(df$R.umol.mm.min)^(1/3)

hist(df$R.umol.mm.min_t)
```

# Plot correlation 

```{r}
plot1<-df%>%
  
  ggplot(aes(x=R.umol.mm.min_t, y=resazurin_total_t))+
  geom_point(color="darkgray")+
  geom_smooth(method="lm", color="black")+
  xlab(expression(paste("Oxygen consumption (Âµmol O" [2], "mm" ^-1, ")" ^(1/3))))+
  ylab(expression(paste("log(Fold change fluorescence mm" ^-1, ")")))+
  geom_text(label="p=0.012", x=0.07, y=0.6)+
  theme_classic(); plot1

ggsave(plot1, filename="figures/oxygen-correlation/correlation.png", width=4, height=4)
```

We expect a positive correlation because I am showing the reciprocal of the respiration values (higher slope = more oxygen produced). 

Conduct correlation test on transformed data. 

```{r}
hist(df$R.umol.mm.min_t)
hist(df$resazurin_total_t)
cor.test(df$R.umol.mm.min_t, df$resazurin_total_t, method=c("pearson"))
```


