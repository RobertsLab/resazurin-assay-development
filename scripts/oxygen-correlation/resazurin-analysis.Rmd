---
title: Resazurin analysis for oxygen-resazurin comparisons
author: "AS Huffmyer"
date: '2025'
output:
  github_document: null
  md_document: default
  html_document:
    code_folding: hide
    toc: true
    toc_depth: 6
    toc_float: true
editor_options: 
  chunk_output_type: console
---

This script analyzes resazurin assays tracking individual oyster measurements to correlate to oxygen measurements.     

# Set up 

Set up workspace, set options, and load required packages.    
```{r}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```

Load libraries. 
```{r}
library(MASS) 
library(tidyverse)
library(ggplot2)
library(readxl)
library(cowplot)
library(lme4)
library(lmerTest)
library(car)
library(effects)
library(emmeans)
library(tools)
```

# Fluorescence 

## Load data 

```{r}
# Set the folder path
folder_path <- "data/oxygen-correlation/plate-files"  

# List all txt files in the folder
file_list <- list.files(path = folder_path, pattern = "\\.txt$", full.names = TRUE, recursive=TRUE)

# Check if any files are found
if (length(file_list) == 0) {
  stop("No txt files found in the specified folder. Check the folder path or file extension.")
}

# Initialize an empty list to store processed data
data_list <- list()

# Loop through each file and load the data
for (file in file_list) {
  # Ensure file is a character string
  if (!is.character(file)) next
  
  # Extract file name without extension
  file_name <- file_path_sans_ext(basename(file))
  
  # Read the text file, skipping the first row (metadata)
  data <- read.delim(file, header = FALSE, skip = 36)
  
  # Assign column names: first column is row labels (A–H), others are 1–12
  colnames(data) <- c("Row", as.character(1:8))
  
  #remove last column
  data<-data%>%select(-ncol(data))
  
  # Convert to long format
  data_long <- data %>%
    pivot_longer(cols = -Row, names_to = "Column", values_to = "Value") %>%
    mutate(
      Column = sprintf("%02d", as.integer(Column)),  # Ensure two-digit column numbers
      Well_ID = paste0(Row, Column),                # Format well ID as "A01", "B02", etc.
      FileName = file_name,                          # Add file name
      plate = str_extract(file_name, "plate\\d+"),  # Extract "plateX"
      date = str_extract(file_name, "^\\d{8}"),     # Extract 8-digit date
      timepoint = str_extract(file_name, "T\\d+") %>% 
        str_remove("T") %>% 
        as.numeric()                                # Convert timepoint to numeric
    ) %>%
    select(FileName, Well_ID, Value, date, plate, timepoint)  # Select relevant columns
  
  # Store the processed data in the list
  data_list[[file_name]] <- data_long
}

# Print an example of processed data
head(data_list[[file_name]])


# Combine all data frames into a single data frame (optional)
combined_data <- bind_rows(data_list, .id = "Source")

# Print the first few rows of the combined data (optional)
head(combined_data)

# Rename columns
combined_data<-combined_data%>%
  rename("well"=Well_ID, resazurin_counts=`Value`)%>%
  mutate(timepoint=as.character(timepoint))

head(combined_data)
```

Load in metadata. 

```{r}
metadata<-read_xlsx(path="data/oxygen-correlation/resazurin_metadata.xlsx")%>%
  mutate(date=as.character(date))
```

Join with data frame. 

```{r}
str(combined_data)
str(metadata)

full_data<-left_join(combined_data, metadata, by=c("date", "plate", "well"))%>%
  filter(!is.na(type))

head(full_data)
```

Load in size data. 

```{r}
size<-read_xlsx("data/oxygen-correlation/size-images/sizes.xlsx")
```

Join with data. 

```{r}
str(full_data)
str(size)

full_data<-left_join(full_data, size, by=c("oyster"))
```

Check number of expected oysters (95). 

```{r}
length(unique(full_data$oyster))
unique(full_data$oyster)
```

Correct. 

## Prep the data 

Plot the raw data. 

```{r}
full_data%>%
  ggplot(aes(x=timepoint, y=resazurin_counts, group=oyster))+
  geom_point()+
  geom_line(aes(group=oyster))+
  theme_classic()
```

Calculate normalized fluorescence at each time point normalized to the starting value at time 0. 
```{r}
full_data<-full_data%>%
  group_by(date, plate, well, oyster)%>%
  group_by(date, plate, well, oyster)%>%
  mutate(fluorescence.norm=resazurin_counts/first(resazurin_counts))
```

Plot again. 

```{r}
full_data%>%
  ggplot(aes(x=timepoint, y=fluorescence.norm, group=oyster))+
  geom_point()+
  geom_line()+
  theme_classic()
```

View blanks

```{r}
full_data%>%
  filter(type=="blank")%>%
  ggplot(aes(x=timepoint, y=fluorescence.norm))+
  geom_point()+
  theme_classic()
```

Calculate mean change in blank at each time point. 

```{r}
blanks<-full_data%>%
  filter(type=="blank")%>%
  group_by(date, timepoint, plate)%>%
  summarise(mean_blank=mean(fluorescence.norm));blanks
```

View summarized blank data. 

```{r}
blanks%>%
  ggplot(aes(x=timepoint, y=mean_blank))+
  geom_point()+
  theme_classic()
```

Subtract blank values from fluorescence values for oysters. 

```{r}
full_data<-left_join(full_data, blanks)

full_data<-full_data%>%
  filter(!type=="blank")%>%
  mutate(fluorescence.corr=fluorescence.norm-mean_blank)
```

Plot again. 

```{r}
full_data%>%
  ggplot(aes(x=timepoint, y=fluorescence.corr, group=oyster))+
  geom_point()+
  geom_line()+
  theme_classic()
```

Size normalize data. 
```{r}
#normalize by length
full_data<-full_data%>%
  mutate(fluorescence.corr.mm=fluorescence.corr/length.mm)
```

Plot again. 

Plot by area normalized. 
```{r}
full_data%>%
  ggplot(aes(x=timepoint, y=fluorescence.corr.mm, group=oyster))+
  geom_point()+
  geom_line()+
  theme_classic()
```

Remove unnecessary columns. 

```{r}
str(full_data)

full_data<-full_data%>%
  select(!Source)%>%
  select(!FileName)%>%
  select(!type)

str(full_data)

full_data<-full_data%>%
  rename(value=fluorescence.corr.mm)
```

## Plots    

```{r}
plot1<-full_data%>%
  ggplot(aes(x=timepoint, y=value, group=oyster))+
  geom_point()+
  geom_line()+
  theme_classic();plot1
```

## Calculate total change in fluorescence 

```{r}
total<-full_data%>%
  filter(timepoint=="3")
```

Plot total change in fluorescence for each oyster. 
```{r}
ggplot(total, aes(x = 1, y = value)) +
  geom_violin()+
  geom_point() +
  theme_classic()
```

## Calculate slope in metabolic rates   

Calculate slope for each oyster. 

```{r}
# nest data 
nested <- full_data %>%
  group_by(oyster) %>%
  nest()

str(nested)
nested$data[[1]]

# group by oyster_id and phase, then fit a linear model of metabolic_rate ~ time
slopes <- nested %>%
  mutate(
    model = map(data, ~ lm(value ~ as.numeric(timepoint), data = .x)),        # fit model
    slope = map_dbl(model, ~ coef(.x)[["as.numeric(timepoint)"]])                      # extract slope
  ) %>%
  select(oyster, slope)
```

Plot slope for each oyster 
```{r}
ggplot(slopes, aes(x = oyster, y = slope)) +
  geom_point() +
  geom_line(aes(group=oyster)) +
  theme_classic()
```

```{r}
hist(slopes$slope)
```

# Generate data frames for correlations

Generate a dataframe with oyster ID, slope, and total fluorescence. 

```{r}
cor_data<-left_join(slopes, total)%>%select(oyster, slope, value)

write_csv(cor_data, file="output/oxygen-correlation/resazurin_oyster_metrics.csv")
```


