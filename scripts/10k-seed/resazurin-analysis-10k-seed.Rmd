---
title: 10K seed resazurin metabolic rate analysis
author: "AS Huffmyer"
date: '2024'
output:
  github_document: null
  md_document: default
  html_document:
    code_folding: hide
    toc: true
    toc_depth: 6
    toc_float: true
editor_options: 
  chunk_output_type: console
---


ADD plots for time of death (1, 2, 3, or 4 h) 

# Set up 

Set up workspace, set options, and load required packages.    
```{r}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```

Load libraries. 
```{r}
library(MASS) 
library(tidyverse)
library(ggplot2)
library(readxl)
library(cowplot)
library(lme4)
library(lmerTest)
library(car)
library(effects)
library(emmeans)
library(RColorBrewer)
library(pROC)
library(pracma)
```

# Load data 

Read in resazurin data
```{r}
#read in files
main_data <- read_csv("data/10k-seed/resazurin_data.csv")

main_data<-main_data%>%
  pivot_longer(names_to="time", values_to="fluorescence", cols=`0`:`4`)%>%
  mutate(time=as.numeric(time))
```

Read in survival data 
```{r}
surv<-read_excel("data/10k-seed/survival_resazurin.xlsx")

surv<-surv%>%
  pivot_longer(names_to="time", values_to="status", cols=`0`:`24`)%>%
  mutate(time=as.numeric(time))%>%
  rename(date=date.resazurin, sample=oyster)%>%
  mutate(sample=as.character(sample))
```

Read in size data 
```{r}
size <- read_csv("data/10k-seed/resazurin-size.csv")%>%select(!notes)%>%mutate(sample=as.character(sample))
```

Combine data
```{r}
main_data<-left_join(main_data, surv)

main_data<-left_join(main_data,size)
```

Add in final mortality status
```{r}
final<-surv%>%
  filter(time==24)%>%
  rename(final.mortality=status)%>%
  select(!time)

main_data<-left_join(main_data, final)
```

We now have resazurin and survival data in the data frame.  

```{r}
main_data<-main_data%>%
  mutate(final.mortality = case_when(
    final.mortality == 0 ~ "alive",
    final.mortality == 1 ~ "dead",
    TRUE ~ as.character(final.mortality)  # To handle any other values
  ))

#add a column for mortality at the 4 hour time point 
main_data<-main_data%>%
  mutate(incubation.mortality = case_when(
    time == 4 & status == 0 ~ "alive", 
    time == 4 & status == 1 ~ "dead",
  ))%>%
  group_by(date, bag, sample) %>% # Group by sample to fill within each sample
  fill(incubation.mortality, .direction = "downup") %>% # Fill both downward and upward
  ungroup()
```

# Data preparation 

Plot the data. 

```{r}
main_data%>%
  ggplot(aes(x=time, y=fluorescence, colour=temperature, group=sample))+
  facet_wrap(~bag*date)+
  geom_point()+
  geom_line()+
  theme_classic()
```

Calculate fluorescence at each time point normalized to the starting value at time 0. 

```{r}
main_data<-main_data%>%
  group_by(date, bag, sample, width.mm, length.mm)%>%
  arrange(date, bag, sample)%>%
  mutate(fluorescence.norm=fluorescence/first(fluorescence))
```

Plot again 

```{r}
main_data%>%
  ggplot(aes(x=time, y=fluorescence.norm, colour=temperature, group=sample))+
  facet_wrap(~bag*date)+
  geom_point()+
  geom_line()+
  theme_classic()
```

View blanks

```{r}
main_data%>%
  filter(type=="blank")%>%
  ggplot(aes(x=time, y=fluorescence.norm, colour=temperature, group=sample))+
  facet_wrap(~bag*date)+
  geom_point()+
  geom_line()+
  theme_classic()
```

Calculate mean change in blank at each time point. 

```{r}
blanks<-main_data%>%
  filter(type=="blank")%>%
  group_by(date, bag, temperature, time)%>%
  summarise(mean_blank=mean(fluorescence.norm))
```

View summarized blank data. 

```{r}
blanks%>%
  ggplot(aes(x=time, y=mean_blank, colour=temperature))+
  facet_wrap(~bag*date)+
  geom_point()+
  geom_line()+
  theme_classic()
```

Subtract blank values from fluorescence values for oysters. 

```{r}
main_data<-left_join(main_data, blanks)

main_data<-main_data%>%
  filter(!type=="blank")%>%
  mutate(value=fluorescence.norm-mean_blank)
```

Plot again. 

```{r}
main_data%>%
  ggplot(aes(x=time, y=value, colour=temperature, group=sample))+
  facet_wrap(~bag*date)+
  geom_point()+
  geom_line()+
  theme_classic()
```

Remove unnecessary columns. 

```{r}
main_data<-main_data%>%
  select(!type)%>%
  select(!fluorescence.norm)%>%
  select(!mean_blank)%>%
  select(!fluorescence)
```

Normalize blank corrected fluorescence to oyster size by dividing fluorescence value (normalized to starting value and blank corrected) by oyster size. Calculate volume by using length and width. 

```{r}
main_data$value.mm<-main_data$value/main_data$length.mm
```

Plot size normalized resazurin response. 

```{r}
main_data%>%
  ggplot(aes(x=time, y=value.mm, colour=temperature, group=sample))+
  facet_wrap(~bag*date)+
  geom_point()+
  geom_line()+
  theme_classic()
```

Plot size and mortality relationships. 

```{r}
main_data%>%
  filter(time==4)%>%
  
  ggplot(aes(x=length.mm, y=final.mortality, colour=final.mortality))+
  geom_violin()+
  ggtitle("final mortality")+
  theme_classic()

main_data%>%
  filter(time==4)%>%
  
  ggplot(aes(x=length.mm, y=incubation.mortality, colour=incubation.mortality))+
  geom_violin()+
  ggtitle("incubation mortality")+
  theme_classic()
```

Set time as a factor. 
```{r}
main_data$time<-as.factor(main_data$time)
```

# Analysis: Size 

## Examine size effects 

View size range. 
```{r}
hist(main_data$length.mm)
```

Remove the two outlier oysters. 

```{r}
main_data<-main_data%>%
  filter(length.mm<35)

hist(main_data$length.mm)
```

View fluorescence values. 

```{r}
hist(main_data$value)
```

View metabolic rates over time as a function of size. 

Calculate AUC prior to size normalization. 

```{r}
auc.size<-main_data%>%
  filter(temperature=="18C")%>%
  filter(incubation.mortality=="alive")%>%
  ungroup()%>%
  select(date, bag, sample, time, length.mm, value)%>%
  
  mutate(time=as.numeric(time))%>%
  group_by(date, bag, sample, length.mm) %>%
  dplyr::summarise(AUC = trapz(time, value));auc.size
  
```

```{r}
size_plot<-auc.size%>%
  
  ggplot(data=., aes(x=length.mm, y=AUC, group=paste(date, bag, sample)))+
  #facet_wrap(~temperature)+
  geom_point(colour="darkgray")+
  geom_smooth(aes(group=1), method="lm", colour="black")+
  xlab("Length (mm)")+
  ylab("AUC")+
  theme_classic();size_plot
```

Export data for aggregate size analysis. 

```{r}
auc.size%>%
  write.csv("output/size/10k_seed_size.csv")

```


# Analysis: Metabolic rates 

Previous stress treatment ("hardening") is not considered here and is included as a random effect. 

## Analysis of metabolic rates in oysters that lived through the 4 h trial 

```{r}
alive_4h_data<-main_data%>%
  filter(incubation.mortality=="alive")%>%
  ungroup()%>%
  dplyr::select(!c(value, length.mm, width.mm, length.mm))

#view sample size 
alive_4h_data%>%
  group_by(time, temperature)%>%
  dplyr::summarise(length(value.mm))%>%
  print(n=100)
```

### Detect outliers 

Build a model including all predictors. 
```{r}
model<-lmer(sqrt(value.mm) ~ time * temperature + (1|hardening) + (1|date:bag:sample), data=alive_4h_data)

qqPlot(residuals(model))

hist(alive_4h_data$value.mm)
```

Identify outliers using standardized residuals. 
```{r}
# Extract raw residuals
alive_4h_data$raw_resid <- residuals(model)

# Standardize residuals
alive_4h_data$std_resid <- alive_4h_data$raw_resid / sd(alive_4h_data$raw_resid)

# Flag potential outliers
outlier_threshold <- 3 #remove if more than 3 standard deviations from mean
alive_4h_data$outlier_flag <- abs(alive_4h_data$std_resid) > outlier_threshold

# Filter rows flagged as outliers
outliers <- alive_4h_data %>% filter(outlier_flag == TRUE)
print(outliers)

# Plot standardized residuals
ggplot(alive_4h_data, aes(x = seq_along(std_resid), y = std_resid)) +
  geom_point(aes(color = outlier_flag), size = 2) +
  geom_hline(yintercept = c(-outlier_threshold, outlier_threshold), linetype = "dashed", color = "red") +
  labs(title = "Standardized Residuals with Outliers", x = "Index", y = "Standardized Residual") +
  theme_minimal()
```

Remove identified outliers (<5 outliers). 
```{r}
alive_4h_data<-alive_4h_data%>%
  filter(!outlier_flag==TRUE)
```

```{r}
hist(alive_4h_data$value.mm)
```

Further remove the highest value outlier. 

```{r}
alive_4h_data<-alive_4h_data%>%
  filter(value.mm<0.4)

hist(alive_4h_data$value.mm)
```

### Analyze model  

Plot raw data. 
```{r}
alive_4h_data%>%
  ggplot(aes(x=time, y=value.mm, colour=temperature, group=paste(date, bag, sample)))+
  geom_point()+
  geom_line()+
  theme_classic()
```

```{r}
model<-lmer((value.mm)^(1/2) ~ time * temperature + (1|hardening) + (1|date:bag:sample), data=alive_4h_data)

summary(model)
anova(model)
lmerTest::rand(model)

qqPlot(residuals(model))
```

### Plot data 

```{r}
plot1<-alive_4h_data%>%

  ggplot(aes(x=time, y=value.mm, color=temperature, fill=temperature, group=temperature))+
  geom_point(alpha=0.3)+
  stat_smooth(method="loess")+
  scale_colour_manual(values=c("darkgrey", "darkred"), name="")+
  scale_fill_manual(values=c("darkgrey", "darkred"), name="")+
  theme_classic()+
  ylab(expression(paste("Fold Change in Fluorescence (mm" ^-1, ")")))+
  ggtitle("A")+
  xlab("Hour");plot1

ggsave(plot1, filename="figures/10k-seed/temperature_alive4h.png", width=5, height=4)
```

### Conduct post hoc tests

#### Effects of temperature over time 
```{r}
anova(model)

emm<-emmeans(model, ~temperature|time, adjust = "tukey")
pairs(emm)
```

### Conduct analysis uing total metabolic activity (area under the curve, AUC)

Calculate area under the curve for each temperature in oysters that survived the trial. 

```{r}
auc_data<-alive_4h_data%>%
  mutate(timepoint=as.numeric(time))%>%
  group_by(date, bag, sample, temperature) %>%
  summarise(AUC = trapz(timepoint, value.mm))

head(auc_data)
```

Plot
```{r}
plot1b<-auc_data%>%
  group_by(temperature)%>%
  summarise(mean=mean(AUC), se=sd(AUC)/sqrt(length(AUC)))%>%

  ggplot(., aes(x = temperature, y = mean, color = temperature, fill = temperature)) +
  geom_point() +
  geom_errorbar(aes(ymin=mean-se, ymax=mean+se), width=0.1) +
  scale_colour_manual(values=c("darkgray", "darkred"), name="Mortality")+
  scale_fill_manual(values=c("darkgray", "darkred"), name="Mortality")+
  geom_text(aes(x=1.5, y=0.45), label="p<0.001", colour="black")+
  ylim(0,0.5)+
  labs(
    title = "B",
    y = expression(paste("AUC")),
    x = "Temperature"
  ) +
  theme_classic()+
  theme(legend.position="none");plot1b

ggsave(plot1b, filename="figures/10k-seed/temperature_alive4h_auc.png", width=3, height=4)
```

```{r}
hist(auc_data$AUC)

model<-lmer(AUC ~ temperature + (1|date:bag), data=auc_data)

summary(model)
anova(model)

qqPlot(residuals(model))
```

## Analysis of metabolic rates in oysters that died during the 4 h trial

```{r}
dead_4h_data<-main_data%>%
  filter(incubation.mortality=="dead")%>%
  ungroup()%>%
  dplyr::select(!c(value, length.mm, width.mm, length.mm))

#view sample size 
dead_4h_data%>%
  group_by(time, temperature)%>%
  dplyr::summarise(length(value.mm))%>%
  print(n=100)
```

There are few samples that died at 18°C, we cannot proceed with comparisons between temperatures.

## Analysis of metabolic rates in live vs dead oysters during the 4 h trial at 42°C

Subset to 42°C.   
```{r}
high_4h_data<-main_data%>%
  filter(temperature=="42C")%>%
  ungroup()%>%
  dplyr::select(!c(value, length.mm, width.mm, length.mm))

#view sample size 
high_4h_data%>%
  group_by(time, temperature, incubation.mortality)%>%
  dplyr::summarise(length(value.mm))%>%
  print(n=100)
```

### Detect outliers 

Build a model including all predictors. 
```{r}
model3<-lmer(sqrt(value.mm) ~ time * incubation.mortality + (1|hardening) + (1|date:bag:sample), data=high_4h_data)

qqPlot(residuals(model3))

hist(high_4h_data$value.mm)
```

Identify using standardized residuals. 
```{r}
# Extract raw residuals
high_4h_data$raw_resid <- residuals(model3)

# Standardize residuals
high_4h_data$std_resid <- high_4h_data$raw_resid / sd(high_4h_data$raw_resid)

# Flag potential outliers
outlier_threshold <- 3
high_4h_data$outlier_flag <- abs(high_4h_data$std_resid) > outlier_threshold

# Filter rows flagged as outliers
outliers <- high_4h_data %>% filter(outlier_flag == TRUE)
print(outliers)

# Plot standardized residuals
ggplot(high_4h_data, aes(x = seq_along(std_resid), y = std_resid)) +
  geom_point(aes(color = outlier_flag), size = 2) +
  geom_hline(yintercept = c(-outlier_threshold, outlier_threshold), linetype = "dashed", color = "red") +
  labs(title = "Standardized Residuals with Outliers", x = "Index", y = "Standardized Residual") +
  theme_minimal()
```

Remove identified outliers. 
```{r}
high_4h_data<-high_4h_data%>%
  filter(!outlier_flag==TRUE)
```

```{r}
hist(high_4h_data$value.mm)
```

Remove upper outlier. 

```{r}
high_4h_data<-high_4h_data%>%
  filter(value.mm<0.25)

hist(high_4h_data$value.mm)
```

### Analyze model  

Plot raw data. 
```{r}
high_4h_data%>%
  ggplot(aes(x=time, y=value.mm, colour=incubation.mortality, group=paste(date,sample)))+
  geom_point()+
  geom_line()+
  theme_classic()
```

```{r}
model3<-lmer(sqrt(value.mm) ~ time * incubation.mortality + (1|hardening) + (1|date:bag:sample), data=high_4h_data)

summary(model3)
anova(model3)

qqPlot(residuals(model3))
```

### Plot data 

```{r}
plot1a<-high_4h_data%>%

  ggplot(aes(x=time, y=value.mm, color=incubation.mortality, fill=incubation.mortality))+
  geom_point(alpha=0.3)+
  geom_smooth(aes(group=incubation.mortality), method="lm")+
  scale_colour_manual(name="Mortality", values=c("black", "gray"))+
  scale_fill_manual(name="Mortality", values=c("black",  "gray"))+
  theme_classic()+
  geom_text(x=2.5, y=0.25, label="p<0.001", colour="black")+
  ylab(expression(paste("Fold Change in Fluorescence (mm" ^-1, ")")))+
  ggtitle("A")+
  xlab("Hours");plot1a

ggsave(plot1a, filename="figures/10k-seed/rates_mortality_4h.png", width=5, height=4)
```

Higher rates in those that died during 4 h incubation.   

### Conduct post hoc tests

#### Effects of mortality within hardening treatment and time 
```{r}
anova(model3)

emm<-emmeans(model3, ~incubation.mortality|time, adjust = "tukey")
pairs(emm)
```


### Calculate percent differences between groups 

```{r}
perc_data<-high_4h_data%>%
  group_by(incubation.mortality, time)%>%
  summarise(mean=mean(value.mm, na.rm=TRUE))%>%
  pivot_wider(names_from=incubation.mortality, values_from=mean)%>%
  filter(!time==0)%>%
  mutate(perc_change=((dead-alive)/alive)*100);perc_data
```

### Analyze AUC 

```{r}
auc_data_dead<-high_4h_data%>%
  mutate(timepoint=as.numeric(time))%>%
  group_by(date, bag, sample, temperature, incubation.mortality) %>%
  summarise(AUC = trapz(timepoint, value.mm))

head(auc_data_dead)
```

Calculate percent change. 
```{r}
perc_data<-auc_data_dead%>%
  group_by(incubation.mortality)%>%
  summarise(mean=mean(AUC, na.rm=TRUE))%>%
  pivot_wider(names_from=incubation.mortality, values_from=mean)%>%
  mutate(perc_change=((alive-dead)/dead)*100);perc_data
```

Run a model.
```{r}
hist(auc_data_dead$AUC)
```

```{r}
model4<-lmer(AUC ~ incubation.mortality + (1|date:bag), data=auc_data_dead)

summary(model4)
anova(model4)

qqPlot(residuals(model4))
```

Post hoc test 

```{r}
emm<-emmeans(model4, ~incubation.mortality, adjust = "tukey")
pairs(emm)
```

Plot AUC 

```{r}
plot4b<-auc_data_dead%>%
  group_by(incubation.mortality)%>%
  summarise(mean=mean(AUC), se=sd(AUC)/sqrt(length(AUC)))%>%
  
  ggplot(., aes(x = incubation.mortality, y = mean, color = incubation.mortality, fill = incubation.mortality)) +
  geom_point() +
  geom_errorbar(aes(ymin=mean-se, ymax=mean+se), width=0.1) +
  scale_colour_manual(values=c("black", "darkgray"), name="Mortality")+
 scale_fill_manual(values=c("black", "darkgray"), name="Mortality")+
  geom_text(aes(x=1.5, y=0.35), label="p<0.001", colour="black")+
  ylim(0,0.4)+
  labs(
    title = "B",
    y = expression(paste("AUC")),
    x = "Mortality"
  ) +
  theme_classic()+
  theme(legend.position="none");plot4b

ggsave(plot4b, filename="figures/10k-seed/auc_mortality_4h.png", width=3, height=4)
```

## Analysis of 4 h mortality risk based on metabolic rate under high temperature in 4 h trial at 42C 

Predict mortality at next time point based on metabolic rate at preceding time point. 
```{r}
# Create a lagged status column
model_data <- high_4h_data %>%
  group_by(paste(date, bag, sample)) %>%
  mutate(next_status = lead(status)) %>%
  ungroup()

#if final mortality at time point 4 = dead, then add 1 to the "next_status" column and if final.mortality = alive, then add 0 to the "next status" column 

model_data <- model_data%>%
  filter(!is.na(next_status))%>%
  select(!c("raw_resid", "std_resid", "outlier_flag"))

# Logistic regression model
model4 <- glmer(next_status ~ scale(value.mm) + (1|hardening) + (1|bag:sample), family = binomial(link = "logit"), data = model_data)

# Summary of the model
summary(model4)
Anova(model4)
```

```{r}
plot(Effect(c("value.mm"), model4))
```

Higher metabolic rate increases mortality risk. 

### Plot data 

Plot effects on next mortality status. 

```{r}
# Logistic regression model for predictions
model_pred1 <- glmer(next_status ~ scale(value.mm) + (1|hardening) + (1|bag:sample), family = binomial(link = "logit"), data = model_data)

# Generate predicted probabilities
model_data$predicted_mortality <- predict(model_pred1, type = "response")

# Compute AUC
roc_curve <- roc(model_data$next_status, model_data$predicted_mortality)
auc_value <- auc(roc_curve)
print(paste("AUC:", round(auc_value, 3)))

# Compute accuracy with a threshold of 0.5
model_data$predicted_class <- ifelse(model_data$predicted_mortality > 0.5, 1, 0)
accuracy <- mean(model_data$predicted_class == model_data$next_status)
print(paste("Accuracy:", round(accuracy, 3)))

# Plot the ROC curve
roc_plot <- ggroc(roc_curve) +
  labs(title = "ROC Curve", x = "False Positive Rate", y = "True Positive Rate") +
  theme_classic();roc_plot

# Add confidence intervals for ROC curve
ci_auc <- ci.auc(roc_curve)
print(paste("AUC 95% CI:", round(ci_auc[1], 3), "-", round(ci_auc[3], 3)))

# Plot
plot12<-ggplot(model_data, aes(x = value.mm, y = predicted_mortality)) +
  geom_point(aes(y = next_status), alpha = 0.5, position = position_jitter(height = 0.03), colour="darkgray") +
  geom_smooth(method = "glm", method.args = list(family = "binomial"), se = TRUE, colour="black") +
  labs(
    title = "",
    x = expression(paste("Fold Change in Fluorescence (mm" ^-1, ")")),
    y = "Predicted Mortality"
  ) +
  theme_classic();plot12

ggsave(plot12, filename="figures/10k-seed/mortality_risk_metabolic_rate_42C_4h.png", width=5, height=4)
```

# Analysis: Survival and classification 

Look at mortality effects over time. 

```{r}
surv<-read_excel("data/10k-seed/survival_resazurin.xlsx")

surv_final<-surv%>%
  pivot_longer(names_to="time", values_to="status", cols=`0`:`24`)%>%
  mutate(time=as.numeric(time))%>%
  rename(date=date.resazurin, sample=oyster)%>%
  mutate(sample=as.character(sample))%>%
  filter(time=="4")
```

## Mortality by temperature  

```{r}
surv_data<-main_data%>%
  ungroup()%>%
  select(c(date, bag, sample, hardening, temperature, time, status))

#add 24 h survival data 
surv_data<-rbind(surv_final, surv_data)

surv_data<-surv_data%>%
  arrange(date, bag, sample)%>%
  mutate(time=as.numeric(as.character(time)))%>%
  arrange(date, bag, sample, time)

str(surv_data)

# Logistic regression model for predictions
model_surv <- glmer(status ~ time * temperature + (1|hardening/bag) + (1|bag:sample), family = binomial(link = "logit"), data = surv_data)

# Generate predicted probabilities
surv_data$predicted_mortality <- predict(model_surv, type = "response")

# Plot
plot3<-ggplot(surv_data, aes(x = as.numeric(time), y = predicted_mortality, color = temperature, fill = temperature)) +
  geom_point(aes(y = status), alpha = 0.6, position = position_jitter(height = 0.03)) +
  geom_smooth(method = "glm", method.args = list(family = "binomial"), se = FALSE) +
  scale_colour_manual(values=c("darkgrey", "darkred"))+
  scale_fill_manual(values=c("darkgrey", "darkred"))+
  labs(
    title = "C",
    y = "Mortality",
    x = "Hours"
  ) +
  theme_classic()+
  theme(legend.position="none");plot3

ggsave(plot3, filename="figures/10k-seed/survival_temperature.png", width=4, height=4)
```

View model results
```{r}
# Summary of the model
summary(model_surv)
Anova(model_surv)
```

Temperature and time affect mortality. 

View a summary of mortality. 

```{r}
table_surv<-surv_data%>%
  
  group_by(temperature, time)%>%
  summarise(mean=mean(status), se=sd(status)/sqrt(length(status)));table_surv
```

